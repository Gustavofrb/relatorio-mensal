name: Fechamento Mensal Automatizado

on:
  schedule:
    - cron: '0 0 1 * *'
  
  workflow_dispatch:
    inputs:
      month:
        description: 'Mês de referência (YYYY-MM). Deixe vazio para mês anterior.'
        required: false
        type: string

jobs:
  monthly-closing:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Instalar dependências
        run: |
          cd src
          pip install -r requirements.txt
      
      - name: Executar fechamento mensal
        id: run_closing
        run: |
          cd src
          if [ -n "${{ github.event.inputs.month }}" ]; then
            python main.py --month "${{ github.event.inputs.month }}"
          else
            python main.py
          fi
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          FINANCE_EMAILS: ${{ secrets.FINANCE_EMAILS }}
          OPERATIONS_EMAILS: ${{ secrets.OPERATIONS_EMAILS }}
          SUPPORT_EMAILS: ${{ secrets.SUPPORT_EMAILS }}
          IT_EMAILS: ${{ secrets.IT_EMAILS }}
          LEADERSHIP_EMAILS: ${{ secrets.LEADERSHIP_EMAILS }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LLM_MODEL: 'gpt-4'
      
      - name: Upload relatórios gerados
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-mensais
          path: |
            src/output/*.csv
            src/output/run.log
          retention-days: 90
      
      - name: Upload banco de dados
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: database
          path: src/data/database.sqlite
          retention-days: 365
      
      - name: Enviar notificação de sucesso no Slack
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": " Fechamento mensal concluído com sucesso",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": " Fechamento Mensal - Sucesso"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Executado por:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Data/Hora:*\n${{ github.event.head_commit.timestamp }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Ver Logs"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
      
      - name: Enviar notificação de erro no Slack
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "ERRO no fechamento mensal",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": " Fechamento Mensal - ERRO"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "O fechamento mensal falhou. Verifique os logs para mais detalhes."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Executado por:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Ver Logs de Erro"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }
      
      - name: Criar issue em caso de falha
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: ' Falha no Fechamento Mensal Automatizado',
              body: `### Detalhes da Falha
              
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              **Ator:** ${context.actor}
              **Data/Hora:** ${new Date().toISOString()}
              
              **Link dos Logs:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              ### Ação Necessária
              
              1. Revisar logs do workflow
              2. Verificar conectividade com API externa
              3. Validar integridade do banco de dados
              4. Executar manualmente se necessário: \`python main.py\`
              
              ---
              Este issue foi criado automaticamente pelo workflow de CI/CD.`,
              labels: ['bug', 'automation', 'high-priority']
            })
